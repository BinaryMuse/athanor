---
phase: 06-instance-and-index-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/athanor/lib/athanor/experiments.ex
  - apps/athanor_web/lib/athanor_web/components/layouts.ex
  - apps/athanor_web/lib/athanor_web/router.ex
autonomous: true
requirements:
  - IDX-01
  - IDX-02

must_haves:
  truths:
    - "Index page can display run count and last run time per experiment card"
    - "All instance pages show minimal nav (logo + theme toggle, no Phoenix boilerplate)"
    - "Edit route exists for configuration editing"
  artifacts:
    - path: "apps/athanor/lib/athanor/experiments.ex"
      provides: "list_instances_with_stats/0 and get_instance_stats/1 aggregate queries"
      contains: "def list_instances_with_stats"
    - path: "apps/athanor_web/lib/athanor_web/components/layouts.ex"
      provides: "Minimal Athanor nav replacing Phoenix boilerplate"
      contains: "Athanor"
    - path: "apps/athanor_web/lib/athanor_web/router.ex"
      provides: "Edit route for instance configuration"
      contains: "/experiments/:id/edit"
  key_links:
    - from: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex"
      to: "apps/athanor/lib/athanor/experiments.ex"
      via: "list_instances_with_stats/0 call"
      pattern: "list_instances_with_stats"
---

<objective>
Prepare backend and global layout for instance page polish.

Purpose: The Index page needs run count and last run time per experiment. The app layout needs its Phoenix boilerplate navbar replaced with Athanor's minimal nav. An edit route is needed for the Edit Config action.

Output: Experiments context with aggregate stats queries, minimal app navbar, edit route in router.
</objective>

<execution_context>
@/Users/binarymuse/.claude/get-shit-done/workflows/execute-plan.md
@/Users/binarymuse/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-instance-and-index-pages/06-CONTEXT.md
@.planning/phases/06-instance-and-index-pages/06-RESEARCH.md
@apps/athanor/lib/athanor/experiments.ex
@apps/athanor_web/lib/athanor_web/components/layouts.ex
@apps/athanor_web/lib/athanor_web/router.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aggregate stats queries to Experiments context</name>
  <files>apps/athanor/lib/athanor/experiments.ex</files>
  <action>
Add two new functions to the Experiments context for aggregate run statistics:

1. `list_instances_with_stats/0` — Returns all instances with run count and last run timestamp via single JOIN query:
```elixir
def list_instances_with_stats do
  from(i in Instance,
    left_join: r in assoc(i, :runs),
    group_by: i.id,
    select: %{
      instance: i,
      run_count: count(r.id),
      last_run_at: max(r.inserted_at)
    },
    order_by: [desc: max(r.inserted_at), asc: i.name]
  )
  |> Repo.all()
end
```

2. `get_instance_stats/1` — Returns stats for a single instance (used by PubSub handlers):
```elixir
def get_instance_stats(instance_id) do
  from(i in Instance,
    left_join: r in assoc(i, :runs),
    where: i.id == ^instance_id,
    group_by: i.id,
    select: %{
      instance: i,
      run_count: count(r.id),
      last_run_at: max(r.inserted_at)
    }
  )
  |> Repo.one()
end
```

These return maps (not structs) because the Index page stream will use these enriched maps. The `dom_id` option on stream will extract ID from `item.instance.id`.
  </action>
  <verify>Run `mix compile` — no errors or warnings in experiments.ex</verify>
  <done>Experiments context has list_instances_with_stats/0 and get_instance_stats/1 functions that return maps with :instance, :run_count, :last_run_at keys</done>
</task>

<task type="auto">
  <name>Task 2: Replace Phoenix boilerplate navbar with Athanor minimal nav</name>
  <files>apps/athanor_web/lib/athanor_web/components/layouts.ex</files>
  <action>
Replace the `app/1` function's header section. Remove Phoenix links (phoenixframework.org, GitHub, Get Started) and replace with Athanor's minimal nav per user decision:

Current boilerplate navbar:
```heex
<header class="navbar px-4 sm:px-6 lg:px-8">
  <div class="flex-1">
    <a href="/" ...>
      <img src={~p"/images/logo.svg"} width="36" />
      <span class="text-sm font-semibold">v{Application.spec(:phoenix, :vsn)}</span>
    </a>
  </div>
  <div class="flex-none">
    <ul ...>
      <li><a href="https://phoenixframework.org/" ...>Website</a></li>
      <li><a href="https://github.com/..." ...>GitHub</a></li>
      <li><.theme_toggle /></li>
      <li><a href="https://hexdocs.pm/..." ...>Get Started</a></li>
    </ul>
  </div>
</header>
```

Replace with minimal Athanor nav:
```heex
<header class="sticky top-0 z-10 bg-base-100 border-b border-base-300">
  <div class="flex items-center justify-between px-4 sm:px-6 lg:px-8 py-3">
    <.link navigate={~p"/experiments"} class="flex items-center gap-2 font-semibold text-base-content hover:text-primary transition-colors">
      Athanor
    </.link>
    <.theme_toggle />
  </div>
</header>
```

Also update the main content container from `max-w-2xl` to `max-w-4xl` for better card layout support:
```heex
<main class="px-4 py-8 sm:px-6 lg:px-8">
  <div class="mx-auto max-w-4xl space-y-4">
    {render_slot(@inner_block)}
  </div>
</main>
```

Keep the existing `run/1` layout unchanged — it already has its own layout for run monitoring.
  </action>
  <verify>Run `mix compile` — no errors. Visit `/experiments` in browser and confirm: (1) navbar shows "Athanor" text linking to /experiments, (2) theme toggle is visible, (3) no Phoenix boilerplate links, (4) content area is wider than before</verify>
  <done>App layout navbar shows "Athanor" + theme toggle only, max-w-4xl content width, sticky header with border</done>
</task>

<task type="auto">
  <name>Task 3: Add edit route to router</name>
  <files>apps/athanor_web/lib/athanor_web/router.ex</files>
  <action>
Add edit route for instance configuration. The edit page will reuse the New page with modifications (handled in Plan 02). For now, just add the route:

After the existing experiment routes:
```elixir
live "/experiments", Experiments.InstanceLive.Index, :index
live "/experiments/new", Experiments.InstanceLive.New, :new
live "/experiments/:id", Experiments.InstanceLive.Show, :show
```

Add:
```elixir
live "/experiments/:id/edit", Experiments.InstanceLive.Edit, :edit
```

The Edit LiveView module will be created in Plan 02. The router change is separated here to verify the route pattern works.
  </action>
  <verify>Run `mix compile` — will show warning about missing module (expected, module created in Plan 02). Verify route exists: `mix phx.routes | grep edit`</verify>
  <done>Router has /experiments/:id/edit route defined, pointing to InstanceLive.Edit</done>
</task>

</tasks>

<verification>
1. `mix compile` completes (Edit module warning expected)
2. `mix phx.routes | grep experiments` shows all 4 routes (index, new, show, edit)
3. Experiments.list_instances_with_stats/0 returns list of maps with :instance, :run_count, :last_run_at
4. Navbar in browser shows "Athanor" + theme toggle, no Phoenix links
</verification>

<success_criteria>
- Experiments context exports list_instances_with_stats/0 and get_instance_stats/1
- App layout has minimal Athanor navbar (logo text + theme toggle)
- App layout main content uses max-w-4xl
- Router has /experiments/:id/edit route
</success_criteria>

<output>
After completion, create `.planning/phases/06-instance-and-index-pages/06-01-SUMMARY.md`
</output>
