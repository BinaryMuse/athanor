---
phase: 06-instance-and-index-pages
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/instance_live/show.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/instance_live/new.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/instance_live/edit.ex
autonomous: true
requirements:
  - IDX-01
  - IDX-02

must_haves:
  truths:
    - "Index page shows card grid with run count, last run time, status badge per experiment"
    - "Index cards have Start Run button, Edit button, and overflow menu with Delete"
    - "Show page has URL-synced tabs (Runs, Configuration) via query params"
    - "Show page header has Start Run button and dropdown menu (Edit/Delete)"
    - "New page has breadcrumb navigation and sticky footer with Cancel/Create"
    - "Edit page allows modifying experiment configuration"
  artifacts:
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex"
      provides: "Card-based index with rich content and actions"
      contains: "list_instances_with_stats"
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/show.ex"
      provides: "Tab-based show page with URL integration"
      contains: "handle_params"
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/new.ex"
      provides: "New page with breadcrumb and sticky footer"
      contains: "sticky"
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/edit.ex"
      provides: "Edit page for instance configuration"
      contains: "update_instance"
  key_links:
    - from: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex"
      to: "apps/athanor/lib/athanor/experiments.ex"
      via: "list_instances_with_stats/0 and get_instance_stats/1"
      pattern: "list_instances_with_stats|get_instance_stats"
    - from: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/show.ex"
      to: "URL query params"
      via: "handle_params/3 for tab state"
      pattern: 'handle_params.*"tab"'
---

<objective>
Refactor all instance LiveViews for polished UI matching design system.

Purpose: Transform functional but minimal pages into polished, consistent UI. Index gets rich cards with stats and actions. Show gets tab-based layout with URL sync. New gets breadcrumbs and sticky footer. Edit page is created for configuration updates.

Output: Four polished LiveView pages following established design system patterns.
</objective>

<execution_context>
@/Users/binarymuse/.claude/get-shit-done/workflows/execute-plan.md
@/Users/binarymuse/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-instance-and-index-pages/06-CONTEXT.md
@.planning/phases/06-instance-and-index-pages/06-RESEARCH.md
@.planning/phases/06-instance-and-index-pages/06-01-SUMMARY.md
@apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex
@apps/athanor_web/lib/athanor_web/live/experiments/instance_live/show.ex
@apps/athanor_web/lib/athanor_web/live/experiments/instance_live/new.ex
@apps/athanor_web/lib/athanor_web/live/experiments/components/status_badge.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Index page for card layout with stats and actions</name>
  <files>apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex</files>
  <action>
Refactor Index LiveView for rich card layout per locked decisions:

**Mount changes:**
1. Replace `Experiments.list_instances()` with `Experiments.list_instances_with_stats()`
2. Stream items are now maps with `:instance`, `:run_count`, `:last_run_at` keys
3. Add `dom_id` option to stream: `stream(:instances, stats, dom_id: fn item -> "instance-#{item.instance.id}" end)`

**Render changes:**
Replace simple card layout with rich cards:

```heex
<div class="text-sm text-base-content/60 mb-4 flex items-center gap-2">
  <span class="text-base-content font-medium">Experiments</span>
</div>

<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-semibold">All Experiments</h1>
  <.link navigate={~p"/experiments/new"} class="btn btn-primary">
    <.icon name="hero-plus-micro" class="size-4 mr-1" /> New Experiment
  </.link>
</div>

<div :if={@instance_count == 0} class="text-center py-12 text-base-content/60">
  <p class="text-lg">No experiments yet.</p>
  <p class="mt-2">
    <.link navigate={~p"/experiments/new"} class="link link-primary">
      Create your first experiment
    </.link>
  </p>
</div>

<div id="instances" phx-update="stream" class="space-y-4">
  <div
    :for={{dom_id, item} <- @streams.instances}
    id={dom_id}
    class="card bg-base-200 shadow-sm"
  >
    <div class="card-body p-4">
      <div class="flex items-start justify-between gap-4">
        <%!-- Card content --%>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <h2 class="card-title text-base">
              <.link navigate={~p"/experiments/#{item.instance.id}"} class="link link-hover">
                {item.instance.name}
              </.link>
            </h2>
          </div>
          <p class="text-sm text-base-content/60">{module_name(item.instance.experiment_module)}</p>
          <p :if={item.instance.description} class="text-sm mt-1 line-clamp-2 text-base-content/80">
            {item.instance.description}
          </p>
          <div class="flex items-center gap-4 mt-2 text-xs text-base-content/50">
            <span>{item.run_count} runs</span>
            <span :if={item.last_run_at}>Last: {format_relative_time(item.last_run_at)}</span>
          </div>
        </div>

        <%!-- Action column --%>
        <div class="flex items-center gap-2 shrink-0">
          <button phx-click="start_run" phx-value-id={item.instance.id} class="btn btn-sm btn-primary">
            <.icon name="hero-play-micro" class="size-3 mr-1" /> Run
          </button>
          <.link navigate={~p"/experiments/#{item.instance.id}/edit"} class="btn btn-sm btn-ghost">
            Edit
          </.link>
          <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-sm btn-square">
              <.icon name="hero-ellipsis-vertical" class="size-4" />
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-200 rounded-box z-10 w-44 p-2 shadow-lg border border-base-300">
              <li>
                <.link navigate={~p"/experiments/#{item.instance.id}"}>View Details</.link>
              </li>
              <li>
                <button phx-click="delete_instance" phx-value-id={item.instance.id}
                        data-confirm="Delete this experiment and all its runs?">
                  <span class="text-error">Delete</span>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
```

**Event handlers:**
Add `start_run` and `delete_instance` handlers:

```elixir
alias Athanor.Runtime

@impl true
def handle_event("start_run", %{"id" => id}, socket) do
  instance = Experiments.get_instance!(id)
  case Runtime.start_run(instance) do
    {:ok, _run} ->
      {:noreply, put_flash(socket, :info, "Run started")}
    {:error, reason} ->
      {:noreply, put_flash(socket, :error, "Failed to start: #{inspect(reason)}")}
  end
end

@impl true
def handle_event("delete_instance", %{"id" => id}, socket) do
  instance = Experiments.get_instance!(id)
  {:ok, _} = Experiments.delete_instance(instance)
  Athanor.Experiments.Broadcasts.instance_deleted(instance)
  {:noreply, socket}
end
```

**PubSub handler updates:**
Update handlers to work with stats maps instead of plain structs:

```elixir
@impl true
def handle_info({:instance_created, instance}, socket) do
  stats = Experiments.get_instance_stats(instance.id)
  socket =
    socket
    |> update(:instance_count, &(&1 + 1))
    |> stream_insert(:instances, stats, at: 0)
  {:noreply, socket}
end

@impl true
def handle_info({:instance_updated, instance}, socket) do
  stats = Experiments.get_instance_stats(instance.id)
  {:noreply, stream_insert(socket, :instances, stats)}
end

# instance_deleted handler unchanged — stream_delete uses the instance struct's id
```

**Helper functions:**
Add `format_relative_time/1` for "2 hours ago" style timestamps:

```elixir
defp format_relative_time(datetime) do
  diff = DateTime.diff(DateTime.utc_now(), datetime, :second)
  cond do
    diff < 60 -> "just now"
    diff < 3600 -> "#{div(diff, 60)} min ago"
    diff < 86400 -> "#{div(diff, 3600)} hours ago"
    diff < 604800 -> "#{div(diff, 86400)} days ago"
    true -> Calendar.strftime(datetime, "%b %d")
  end
end
```

Keep existing `module_name/1` helper.
  </action>
  <verify>Run `mix compile` — no errors. Visit `/experiments` and verify: (1) cards show run count and last run time, (2) Start Run button works and shows flash, (3) Edit button navigates (will 404 until Edit page exists), (4) Delete in overflow menu works with confirmation</verify>
  <done>Index page shows rich cards with run stats, Start Run button, Edit button, and overflow menu with Delete</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Show page for tab-based layout with URL sync</name>
  <files>apps/athanor_web/lib/athanor_web/live/experiments/instance_live/show.ex</files>
  <action>
Refactor Show LiveView for tab-based layout per locked decisions:

**Add handle_params for URL-synced tabs:**
```elixir
@impl true
def handle_params(%{"tab" => tab}, _uri, socket) when tab in ["runs", "configuration"] do
  {:noreply, assign(socket, :active_tab, String.to_existing_atom(tab))}
end

def handle_params(_params, _uri, socket) do
  {:noreply, assign(socket, :active_tab, :runs)}
end
```

**Update mount to initialize active_tab:**
Add `|> assign(:active_tab, :runs)` to initial socket assigns.

**Refactor render for tab-based layout:**

```heex
<%!-- Breadcrumb --%>
<div class="text-sm text-base-content/60 mb-4 flex items-center gap-2">
  <.link navigate={~p"/experiments"} class="hover:text-base-content">Experiments</.link>
  <span>/</span>
  <span class="text-base-content">{@instance.name}</span>
</div>

<%!-- Header with actions --%>
<div class="flex items-start justify-between gap-4 mb-6">
  <div>
    <h1 class="text-2xl font-semibold">{@instance.name}</h1>
    <p class="text-base-content/60 mt-1">{module_name(@instance.experiment_module)}</p>
  </div>

  <div class="flex items-center gap-2">
    <.button phx-click="start_run" class="btn-primary">
      <.icon name="hero-play" class="size-4 mr-1" /> Start Run
    </.button>

    <div class="dropdown dropdown-end">
      <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
        <.icon name="hero-ellipsis-vertical" class="size-5" />
      </div>
      <ul tabindex="0" class="dropdown-content menu bg-base-200 rounded-box z-10 w-48 p-2 shadow-lg border border-base-300">
        <li>
          <.link navigate={~p"/experiments/#{@instance.id}/edit"}>
            Edit Configuration
          </.link>
        </li>
        <li>
          <button phx-click="delete_instance" data-confirm="Delete this experiment and all its runs?">
            <span class="text-error">Delete</span>
          </button>
        </li>
      </ul>
    </div>
  </div>
</div>

<%!-- Description (if exists) --%>
<p :if={@instance.description} class="text-base-content/80 mb-6">{@instance.description}</p>

<%!-- Tabs --%>
<div role="tablist" class="tabs tabs-bordered border-b border-base-300 mb-6">
  <.link
    patch={~p"/experiments/#{@instance.id}?tab=runs"}
    role="tab"
    class={["tab", @active_tab == :runs && "tab-active"]}
  >
    Runs ({@run_count})
  </.link>
  <.link
    patch={~p"/experiments/#{@instance.id}?tab=configuration"}
    role="tab"
    class={["tab", @active_tab == :configuration && "tab-active"]}
  >
    Configuration
  </.link>
</div>

<%!-- Runs tab panel --%>
<div class={[@active_tab != :runs && "hidden"]}>
  <div :if={@run_count == 0} class="text-center py-8 text-base-content/60">
    No runs yet. Click "Start Run" to begin.
  </div>

  <div id="runs" phx-update="stream" class="space-y-3">
    <.link
      :for={{dom_id, run} <- @streams.runs}
      id={dom_id}
      navigate={~p"/runs/#{run.id}"}
      class="flex items-center justify-between p-4 bg-base-200 rounded-lg hover:bg-base-300 transition-colors"
    >
      <div class="flex items-center gap-4">
        <StatusBadge.status_badge status={run.status} />
        <div>
          <span class="font-medium">Run {short_id(run.id)}</span>
          <p class="text-sm text-base-content/60">{format_time(run.inserted_at)}</p>
        </div>
      </div>
      <div class="flex items-center gap-4 text-sm text-base-content/60">
        <span :if={run.completed_at}>{format_duration(run.started_at, run.completed_at)}</span>
        <.icon name="hero-chevron-right-micro" class="size-4" />
      </div>
    </.link>
  </div>
</div>

<%!-- Configuration tab panel --%>
<div class={[@active_tab != :configuration && "hidden"]}>
  <div class="card bg-base-200">
    <div class="card-body">
      <.render_config config={@instance.configuration} />
      <div :if={@instance.configuration == %{} or is_nil(@instance.configuration)}
           class="text-base-content/60 italic">
        No configuration set
      </div>
    </div>
  </div>
</div>
```

**Add delete_instance handler:**
```elixir
@impl true
def handle_event("delete_instance", _params, socket) do
  {:ok, _} = Experiments.delete_instance(socket.assigns.instance)
  Athanor.Experiments.Broadcasts.instance_deleted(socket.assigns.instance)
  {:noreply,
   socket
   |> put_flash(:info, "Experiment deleted")
   |> push_navigate(to: ~p"/experiments")}
end
```

**Update render_config for improved styling:**
```elixir
defp render_config(assigns) do
  ~H"""
  <div class="space-y-3">
    <%= for {key, value} <- @config || %{} do %>
      <div class="flex items-start gap-4 py-2 border-b border-base-300 last:border-0">
        <span class="text-sm text-base-content/60 w-1/3 font-medium">{humanize(key)}</span>
        <span class="text-sm font-mono text-base-content flex-1">{format_value(value)}</span>
      </div>
    <% end %>
  </div>
  """
end
```
  </action>
  <verify>Run `mix compile` — no errors. Visit `/experiments/:id` and verify: (1) tabs appear and switch via URL, (2) URL shows ?tab=runs or ?tab=configuration, (3) browser back/forward works with tabs, (4) Delete in dropdown works and redirects to index</verify>
  <done>Show page has URL-synced tabs (Runs, Configuration), header with Start Run and dropdown menu, breadcrumb navigation</done>
</task>

<task type="auto">
  <name>Task 3: Refactor New page and create Edit page</name>
  <files>
    apps/athanor_web/lib/athanor_web/live/experiments/instance_live/new.ex
    apps/athanor_web/lib/athanor_web/live/experiments/instance_live/edit.ex
  </files>
  <action>
**New page refactoring:**

Update New LiveView with breadcrumb and sticky footer per locked decisions:

1. Replace `<.header>` with breadcrumb:
```heex
<div class="text-sm text-base-content/60 mb-4 flex items-center gap-2">
  <.link navigate={~p"/experiments"} class="hover:text-base-content">Experiments</.link>
  <span>/</span>
  <span class="text-base-content">New</span>
</div>

<h1 class="text-2xl font-semibold mb-6">New Experiment</h1>
```

2. Add `id="new-instance-form"` to the form tag and wrap content with bottom padding:
```heex
<div class="pb-24">
  <.form for={@form} id="new-instance-form" phx-submit="save" class="space-y-6">
    <%!-- form fields unchanged --%>
  </.form>
</div>
```

3. Remove inline submit/cancel buttons from form body (inside the `:if={@selected_experiment}` block).

4. Add sticky footer outside the form:
```heex
<div class="fixed bottom-0 left-0 right-0 bg-base-100 border-t border-base-300 px-4 py-3">
  <div class="mx-auto max-w-4xl flex justify-end gap-3">
    <.link navigate={~p"/experiments"} class="btn btn-ghost">Cancel</.link>
    <button type="submit" form="new-instance-form" class="btn btn-primary" disabled={is_nil(@selected_experiment)}>
      Create Instance
    </button>
  </div>
</div>
```

5. Remove the debug `IO.puts` line from mount.

**Create Edit page:**

Create new file `apps/athanor_web/lib/athanor_web/live/experiments/instance_live/edit.ex`:

```elixir
defmodule AthanorWeb.Experiments.InstanceLive.Edit do
  use AthanorWeb, :live_view

  alias Athanor.Experiments
  alias Athanor.Experiments.{Instance, Discovery}
  alias Athanor.Experiment.ConfigSchema
  alias AthanorWeb.Experiments.Components.ConfigFormComponent

  @impl true
  def mount(%{"id" => id}, _session, socket) do
    instance = Experiments.get_instance!(id)
    changeset = Instance.changeset(instance, %{})

    config_schema_json =
      case Discovery.get_config_schema(instance.experiment_module) do
        {:ok, schema} -> schema |> ConfigSchema.to_serializable() |> Jason.encode!()
        {:error, _} -> nil
      end

    socket =
      socket
      |> assign(:instance, instance)
      |> assign(:config_schema_json, config_schema_json)
      |> assign(:form, to_form(changeset))

    {:ok, socket}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div class="text-sm text-base-content/60 mb-4 flex items-center gap-2">
      <.link navigate={~p"/experiments"} class="hover:text-base-content">Experiments</.link>
      <span>/</span>
      <.link navigate={~p"/experiments/#{@instance.id}"} class="hover:text-base-content">{@instance.name}</.link>
      <span>/</span>
      <span class="text-base-content">Edit</span>
    </div>

    <h1 class="text-2xl font-semibold mb-6">Edit Configuration</h1>

    <div class="pb-24">
      <.form for={@form} id="edit-instance-form" phx-submit="save" class="space-y-6">
        <.input field={@form[:name]} label="Name" placeholder="Experiment name" />

        <.input
          field={@form[:description]}
          type="textarea"
          label="Description"
          placeholder="Optional description..."
        />

        <div :if={@config_schema_json} class="space-y-4">
          <div class="divider">Configuration</div>
          <ConfigFormComponent.config_form
            schema_json={@config_schema_json}
            initial_values={Jason.encode!(@instance.configuration || %{})}
          />
        </div>
      </.form>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-base-100 border-t border-base-300 px-4 py-3">
      <div class="mx-auto max-w-4xl flex justify-end gap-3">
        <.link navigate={~p"/experiments/#{@instance.id}"} class="btn btn-ghost">Cancel</.link>
        <button type="submit" form="edit-instance-form" class="btn btn-primary">
          Save Changes
        </button>
      </div>
    </div>
    """
  end

  @impl true
  def handle_event("save", %{"instance" => params}, socket) do
    config =
      case params["configuration_json"] do
        nil -> socket.assigns.instance.configuration || %{}
        "" -> socket.assigns.instance.configuration || %{}
        json ->
          case Jason.decode(json) do
            {:ok, decoded} -> decoded
            {:error, _} -> socket.assigns.instance.configuration || %{}
          end
      end

    params =
      params
      |> Map.put("configuration", config)
      |> Map.delete("configuration_json")

    case Experiments.update_instance(socket.assigns.instance, params) do
      {:ok, instance} ->
        Athanor.Experiments.Broadcasts.instance_updated(instance)

        {:noreply,
         socket
         |> put_flash(:info, "Configuration updated")
         |> push_navigate(to: ~p"/experiments/#{instance.id}")}

      {:error, changeset} ->
        {:noreply, assign(socket, :form, to_form(changeset))}
    end
  end
end
```

**Update ConfigFormComponent to accept initial_values:**

The ConfigFormComponent already accepts `schema_json`. For edit mode, we need to pass existing config values. Check if `initial_values` attr exists — if not, add it as optional attr:

In `apps/athanor_web/lib/athanor_web/live/experiments/components/config_form_component.ex`, ensure the component accepts `initial_values`:
```elixir
attr :initial_values, :string, default: nil
```

And pass to data attribute:
```heex
data-initial-values={@initial_values}
```

The JS hook (ConfigFormHook) should already support initial values or can be updated to read from this attribute.
  </action>
  <verify>Run `mix compile` — no errors. Test: (1) New page has breadcrumb and sticky footer, (2) New page Create Instance button is disabled until experiment selected, (3) Edit page loads existing instance data, (4) Edit page Save Changes updates instance and redirects to Show</verify>
  <done>New page has breadcrumb and sticky footer with disabled state. Edit page exists with same form pattern, loads existing data, and saves updates.</done>
</task>

</tasks>

<verification>
1. `mix compile` completes with no errors
2. Index page: cards show run count + last run time, Start Run works, Edit navigates to edit page, Delete in overflow works
3. Show page: tabs work with URL sync (?tab=runs, ?tab=configuration), browser back/forward preserves tab state
4. New page: breadcrumb shows "Experiments / New", sticky footer visible, Create disabled until experiment selected
5. Edit page: loads at /experiments/:id/edit, shows existing name/description/config, Save updates and redirects
</verification>

<success_criteria>
- Index page shows rich cards with run stats and full action set (Run, Edit, Delete)
- Show page has URL-synced tabs and action dropdown
- New page has breadcrumb navigation and sticky footer
- Edit page allows modifying experiment configuration
- All pages follow established design system (semantic colors, daisyUI components)
</success_criteria>

<output>
After completion, create `.planning/phases/06-instance-and-index-pages/06-02-SUMMARY.md`
</output>
