---
phase: 06-instance-and-index-pages
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/athanor_web/assets/js/app.js
  - apps/athanor/lib/athanor/experiments.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex
autonomous: true
gap_closure: true
requirements: [IDX-01, IDX-02]

must_haves:
  truths:
    - "Edit page config form pre-populates with existing instance configuration values when visiting /experiments/:id/edit"
    - "Index page experiment cards display a status badge showing the status of the last run"
  artifacts:
    - path: "apps/athanor_web/assets/js/app.js"
      provides: "ConfigFormHook that reads data-initial-values and deep-merges into state on mount"
      contains: "dataset.initialValues"
    - path: "apps/athanor/lib/athanor/experiments.ex"
      provides: "list_instances_with_stats/0 and get_instance_stats/1 including last_run_status"
      contains: "last_run_status"
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex"
      provides: "Index page cards with StatusBadge for last run status"
      contains: "StatusBadge"
  key_links:
    - from: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/edit.ex"
      to: "apps/athanor_web/assets/js/app.js"
      via: "data-initial-values attribute consumed by ConfigFormHook mounted()"
      pattern: "dataset\\.initialValues"
    - from: "apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex"
      to: "apps/athanor/lib/athanor/experiments.ex"
      via: "item.last_run_status from list_instances_with_stats/0"
      pattern: "last_run_status"
---

<objective>
Fix the edit page config pre-population gap (Gap 1) by wiring the ConfigFormHook to read `data-initial-values`, and close the status badge warning (Gap 4) by adding last_run_status to the stats queries and rendering a StatusBadge on index cards.

Purpose: The edit page currently shows empty/default config fields instead of the instance's saved configuration — a critical UX failure. The index cards lack the status badge that was specified in the phase must_haves. Both gaps are in different subsystems (JS hook vs. backend query + template) but neither has file conflicts with Plan 03, so they run in parallel (Wave 1).

Output: ConfigFormHook merges initial values on mount; index cards show a status badge for the last run.
</objective>

<execution_context>
@/Users/binarymuse/.claude/get-shit-done/workflows/execute-plan.md
@/Users/binarymuse/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-instance-and-index-pages/06-01-SUMMARY.md
@.planning/phases/06-instance-and-index-pages/06-02-SUMMARY.md
@apps/athanor_web/assets/js/app.js
@apps/athanor/lib/athanor/experiments.ex
@apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex
@apps/athanor_web/lib/athanor_web/live/experiments/components/status_badge.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire ConfigFormHook to read data-initial-values on mount</name>
  <files>apps/athanor_web/assets/js/app.js</files>
  <action>
In `apps/athanor_web/assets/js/app.js`, update the `ConfigFormHook.mounted()` function to read `this.el.dataset.initialValues` after `initStateFromSchema` and deep-merge the parsed JSON into `this.state` before calling `render()`.

Current `mounted()`:
```js
mounted() {
  this.schema = JSON.parse(this.el.dataset.schema);
  this.state = this.initStateFromSchema(this.schema);
  this.touched = new Set();
  this.errors = new Map();
  this.render();
  this.bindEvents();
},
```

Replace with:
```js
mounted() {
  this.schema = JSON.parse(this.el.dataset.schema);
  this.state = this.initStateFromSchema(this.schema);
  this.touched = new Set();
  this.errors = new Map();

  // Merge existing values (edit mode) — data-initial-values set by ConfigFormComponent
  if (this.el.dataset.initialValues) {
    try {
      const initialValues = JSON.parse(this.el.dataset.initialValues);
      this.state = this.deepMerge(this.state, initialValues);
    } catch (e) {
      // Ignore invalid JSON — fall back to schema defaults
    }
  }

  this.render();
  this.bindEvents();
},
```

Also add a `deepMerge` helper method to the ConfigFormHook object (after `humanize` at the end of the hook, before the closing `},` of `ConfigFormHook`):

```js
deepMerge(target, source) {
  // Deep merge source into target, returning a new object.
  // Arrays are replaced entirely (not merged), which matches
  // how the config hook manages list state.
  const result = { ...target };
  for (const key of Object.keys(source)) {
    if (
      source[key] !== null &&
      typeof source[key] === "object" &&
      !Array.isArray(source[key]) &&
      typeof target[key] === "object" &&
      target[key] !== null &&
      !Array.isArray(target[key])
    ) {
      result[key] = this.deepMerge(target[key], source[key]);
    } else {
      result[key] = source[key];
    }
  }
  return result;
},
```

The merge strategy:
- Scalar values (string, number, boolean, null): initial value wins over schema default
- Objects/groups: recursively merged so nested schema defaults still apply for missing keys
- Arrays/lists: initial value replaces entirely (hook manages list state as arrays)

This fix applies ONLY to the `mounted()` call. The `handleEvent("config_schema_changed", ...)` path intentionally resets to schema defaults (correct behavior when switching experiment type on the New page).
  </action>
  <verify>
1. Check the file was saved and contains `dataset.initialValues` in `mounted()`.
2. Check `deepMerge` method exists in ConfigFormHook.
3. The `handleEvent` for `config_schema_changed` should NOT be changed — verify it still calls `this.initStateFromSchema(this.schema)` only (no initial values merge there).
4. Build check: `cd apps/athanor_web && mix assets.build` or equivalent to ensure no JS syntax errors.
  </verify>
  <done>
`ConfigFormHook.mounted()` reads `this.el.dataset.initialValues`, parses it, and merges into state before rendering. Visiting `/experiments/:id/edit` for an instance with saved configuration now shows the existing values pre-populated in the form fields. The `handleEvent("config_schema_changed")` path is unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add last_run_status to stats queries and render StatusBadge on index cards</name>
  <files>
    apps/athanor/lib/athanor/experiments.ex
    apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex
  </files>
  <action>
**Step A — Update experiments.ex queries to include last_run_status:**

In `apps/athanor/lib/athanor/experiments.ex`, update both `list_instances_with_stats/0` and `get_instance_stats/1` to include the status of the last run.

The Ecto aggregate query currently does:
```elixir
select: %{
  instance: i,
  run_count: count(r.id),
  last_run_at: max(r.inserted_at)
}
```

Update both query `select:` maps to also include `last_run_status`. Since Ecto's `max()` aggregation only works on comparable types, use a fragment to get the status of the most recent run. The approach is to use a correlated subquery via a lateral join or simply select the `status` field with a `fragment` that picks the most-recent row's status.

Use this approach — add a filter via `filter` aggregate or use `fragment`:

```elixir
select: %{
  instance: i,
  run_count: count(r.id),
  last_run_at: max(r.inserted_at),
  last_run_status: fragment(
    "(SELECT status FROM runs WHERE instance_id = ? ORDER BY inserted_at DESC LIMIT 1)",
    i.id
  )
}
```

Apply this same change to both `list_instances_with_stats/0` and `get_instance_stats/1`.

The fake_stats map in `handle_info({:instance_deleted, ...})` in index.ex also needs updating to include the new key:
```elixir
fake_stats = %{instance: instance, run_count: 0, last_run_at: nil, last_run_status: nil}
```

**Step B — Render StatusBadge on index cards:**

In `apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex`:

1. Add the alias at the top of the module:
```elixir
alias AthanorWeb.Experiments.Components.StatusBadge
```

2. In the card template, add a status badge to the card content area. Place it inline with the experiment name in the `flex items-center gap-2 mb-1` div, after the `<h2>` tag:

```heex
<div class="flex items-center gap-2 mb-1">
  <h2 class="card-title text-base">
    <.link navigate={~p"/experiments/#{item.instance.id}"} class="link link-hover">
      {item.instance.name}
    </.link>
  </h2>
  <StatusBadge.status_badge :if={item.last_run_status} status={item.last_run_status} />
</div>
```

The badge only renders when `last_run_status` is non-nil (i.e., there has been at least one run). For experiments with no runs, the badge is hidden — the run count of "0 runs" already conveys that state.
  </action>
  <verify>
1. `mix compile` (from project root or apps/athanor) passes with no errors.
2. Grep for `last_run_status` in `experiments.ex` — should appear in both `list_instances_with_stats/0` and `get_instance_stats/1`.
3. Grep for `StatusBadge` in `index.ex` — should appear as an alias and in the template.
4. Check `fake_stats` map in `index.ex` `handle_info({:instance_deleted, ...})` includes `last_run_status: nil`.
  </verify>
  <done>
Both `list_instances_with_stats/0` and `get_instance_stats/1` return maps with `last_run_status` field. The index page cards render a `StatusBadge` for instances that have at least one run, showing the status of their most recent run. Codebase compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- [ ] `mix compile` passes for all apps
- [ ] `apps/athanor_web/assets/js/app.js` contains `dataset.initialValues` in `mounted()`
- [ ] `apps/athanor_web/assets/js/app.js` contains `deepMerge` helper method
- [ ] `handleEvent("config_schema_changed")` is unchanged (no initial values merge)
- [ ] `apps/athanor/lib/athanor/experiments.ex` both stats functions include `last_run_status` in select
- [ ] `apps/athanor_web/lib/athanor_web/live/experiments/instance_live/index.ex` imports `StatusBadge` and renders it conditionally
- [ ] `fake_stats` map in `handle_info({:instance_deleted})` includes `last_run_status: nil`
</verification>

<success_criteria>
Edit page config pre-population: visiting `/experiments/:id/edit` for an instance with saved configuration shows pre-populated form fields (not schema defaults). Index status badge: experiment cards show a colored status badge (green for completed, red for failed, blue/teal for running) for experiments that have at least one run.
</success_criteria>

<output>
After completion, create `.planning/phases/06-instance-and-index-pages/06-04-SUMMARY.md`
</output>
