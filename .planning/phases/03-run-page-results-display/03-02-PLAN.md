---
phase: 03-run-page-results-display
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Result cards load instantly regardless of result count"
    - "Tree content only renders when user expands a result card"
    - "Expanded result cards display full collapsible tree"
    - "All existing tree/JSON toggle functionality preserved"
  artifacts:
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex"
      provides: "Lazy tree hydration with collapsed-by-default result cards"
      contains: "hydrated"
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex"
      provides: "handle_event for hydrate_result"
      contains: "hydrate_result"
  key_links:
    - from: "results_panel.ex"
      to: "show.ex"
      via: "phx-click hydrate_result event"
      pattern: 'phx-click="hydrate_result"'
    - from: "show.ex handle_event"
      to: "results stream"
      via: "stream_insert with hydrated result"
      pattern: "stream_insert.*:results"
---

<objective>
Implement lazy tree hydration for result cards to eliminate multi-second page load times when many results exist.

Purpose: Address PERF-01 verification gap — rendering full recursive tree DOM for all results upfront causes slow page loads. Show only result key/name initially in collapsed state; hydrate full tree content via server callback when user clicks to expand.

Output: Result cards load instantly with deferred tree rendering on demand.
</objective>

<execution_context>
@/Users/binarymuse/.claude/get-shit-done/workflows/execute-plan.md
@/Users/binarymuse/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-run-page-results-display/03-01-SUMMARY.md
@.planning/phases/03-run-page-results-display/03-RESEARCH.md
@apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex
@apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hydration tracking to results stream</name>
  <files>apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex</files>
  <action>
Modify the results stream to track hydration state per result:

1. In `mount/3`, when streaming results from `Experiments.list_results(run)`:
   - Map each result to include `hydrated: false` field: `Enum.map(results, &Map.put(&1, :hydrated, false))`
   - Stream these augmented results

2. In `handle_info({:result_added, result}, socket)`:
   - Add `hydrated: false` to new results before stream_insert: `result = Map.put(result, :hydrated, false)`

3. In `handle_info({:results_added, results}, socket)`:
   - Add `hydrated: false` to each new result before stream_insert

4. Add new `handle_event("hydrate_result", %{"id" => id}, socket)`:
   - Fetch the result from DB: `Experiments.get_result!(id)`
   - Add `hydrated: true` to the result: `result = Map.put(result, :hydrated, true)`
   - Use `stream_insert(:results, result)` to update the stream item in place
   - Return `{:noreply, socket}`

The stream_insert with same ID replaces the existing item, which will trigger the component to re-render with the hydrated content.
  </action>
  <verify>
`mix compile` succeeds with no warnings in show.ex. The `handle_event("hydrate_result", ...)` function exists.
  </verify>
  <done>
Results stream items have `hydrated` field. `hydrate_result` event handler updates the stream item to `hydrated: true`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement lazy rendering in ResultsPanel</name>
  <files>apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex</files>
  <action>
Modify `result_card/1` to conditionally render tree content based on `hydrated` status:

1. Add `hydrated` to the result attrs check (result map now has `:hydrated` key)

2. When `@result.hydrated == false` (collapsed/not hydrated):
   - Render only the result key with a clickable expand row
   - Use `phx-click="hydrate_result"` with `phx-value-id={@result.id}` to trigger hydration
   - Show a collapsed indicator (chevron pointing right)
   - Do NOT render `json_tree` or the raw JSON view — this is the key performance fix

3. When `@result.hydrated == true` (expanded/hydrated):
   - Render the full result_card as it currently exists: tree view, JSON toggle, json_tree component
   - Add a collapse row at the top that resets to collapsed state (optional — can be deferred if complex)

The collapsed view should look like:
```heex
<div class="flex items-center gap-2 cursor-pointer hover:text-primary" phx-click="hydrate_result" phx-value-id={@result.id}>
  <span class="text-base-content/40 text-xs">></span>
  <span class="font-medium text-sm font-mono text-base-content">{@result.key}</span>
  <span class="text-base-content/40 text-xs ml-auto">Click to expand</span>
</div>
```

The expanded view preserves all existing functionality: tree view with expand/collapse, JSON toggle button, raw JSON view.

Key: Do NOT use `:if` guards that still evaluate the json_tree component — use separate function heads or explicit conditional branches that completely skip tree rendering when not hydrated.
  </action>
  <verify>
`mix compile` succeeds with no warnings in results_panel.ex. Inspect the rendered HTML: collapsed result cards should have NO nested `<ul>` tree structure, only a single clickable row.
  </verify>
  <done>
Result cards render as single-row collapsed stubs initially. Clicking a stub triggers `hydrate_result` event. After hydration, full tree and JSON toggle are rendered.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify lazy loading works end-to-end</name>
  <files>apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex, apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex</files>
  <action>
Verify the implementation:

1. Run `mix compile` — no warnings
2. Start the dev server: `mix phx.server`
3. Navigate to a run page with multiple results
4. Verify:
   - Page loads quickly (no multi-second delay)
   - Result cards show only the key name initially (collapsed)
   - Clicking a result card expands it to show the full tree
   - Tree expand/collapse within the result still works (JS.toggle_class)
   - JSON toggle button appears and works
   - New results streaming in also appear collapsed

If any issues found, fix them before completing this task.
  </action>
  <verify>
Manual browser test confirms: page loads fast, clicking result expands it, tree/JSON toggle works, existing functionality preserved.
  </verify>
  <done>
Lazy tree hydration working: result cards load as stubs, expand on click to show full tree, all existing functionality preserved.
  </done>
</task>

</tasks>

<verification>
1. Page load time: Run page with 50+ results loads in under 1 second (vs multi-second before)
2. Functional: Clicking collapsed result expands it with full tree view
3. Tree interaction: Nested tree nodes still expand/collapse via JS.toggle_class
4. JSON toggle: Toggle JSON button still switches between tree and raw JSON views
5. Real-time: New results streaming in appear collapsed (not hydrated)
6. No regressions: All Phase 3 success criteria still met
</verification>

<success_criteria>
- Result cards render as lightweight stubs on initial page load
- Clicking a result card hydrates it via server roundtrip
- Hydrated results display full collapsible tree with JSON toggle
- Page load time significantly improved for runs with many results
- All existing tree navigation and view toggle functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-run-page-results-display/03-02-SUMMARY.md`
</output>
