---
phase: 04-run-page-layout-and-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/athanor_web/lib/athanor_web/components/layouts.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/components/status_badge.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/components/log_panel.ex
  - apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex
  - apps/athanor_web/assets/js/app.js
autonomous: true

must_haves:
  truths:
    - "Run status and progress are visible without scrolling (sticky header)"
    - "Log and results panels are arranged as tabs"
    - "Tabs show counts: Logs (N) and Results (N)"
    - "Logs tab is the default active tab"
    - "Running state shows pulsing badge"
    - "Elapsed time displays live during running and freezes at completion"
    - "Reconnection indicator shows attempt count in header"
    - "Refresh button appears after reconnection"
    - "Cancel button is visible in sticky header during running state"
  artifacts:
    - path: "apps/athanor_web/lib/athanor_web/components/layouts.ex"
      provides: "run/1 layout function without max-w-2xl constraint"
      contains: "def run(assigns)"
    - path: "apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex"
      provides: "Refactored run page with sticky header, tabs, elapsed ticker, reconnection state"
      contains: "layout: {AthanorWeb.Layouts, :run}"
    - path: "apps/athanor_web/assets/js/app.js"
      provides: "ReconnectionTracker hook"
      contains: "ReconnectionTracker:"
  key_links:
    - from: "apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex"
      to: "apps/athanor_web/lib/athanor_web/components/layouts.ex"
      via: "layout override in mount return"
      pattern: "layout:.*AthanorWeb\\.Layouts.*:run"
    - from: "apps/athanor_web/assets/js/app.js"
      to: "apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex"
      via: "ReconnectionTracker hook pushes reconnecting/reconnected events"
      pattern: "pushEvent.*reconnect"
---

<objective>
Refactor RunLive.Show with a dedicated wide layout, sticky header with run status dashboard, tabbed logs/results panels, live elapsed time ticker, and reconnection handling.

Purpose: Create a polished run monitoring experience where critical run status is always visible regardless of scroll position, and log/results content is organized in tabs with counts for quick reference.

Output: Complete run page layout with sticky header, tab-based panels, and reconnection UX.
</objective>

<execution_context>
@/Users/binarymuse/.claude/get-shit-done/workflows/execute-plan.md
@/Users/binarymuse/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-run-page-layout-and-status/04-RESEARCH.md
@apps/athanor_web/lib/athanor_web/components/layouts.ex
@apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex
@apps/athanor_web/lib/athanor_web/live/experiments/components/status_badge.ex
@apps/athanor_web/lib/athanor_web/live/experiments/components/log_panel.ex
@apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex
@apps/athanor_web/assets/js/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dedicated run layout and update StatusBadge</name>
  <files>
    apps/athanor_web/lib/athanor_web/components/layouts.ex
    apps/athanor_web/lib/athanor_web/live/experiments/components/status_badge.ex
  </files>
  <action>
    1. In layouts.ex, add a new `run/1` function component (after `app/1`) that provides a wide layout without the max-w-2xl constraint:
       - attr :flash, :map, required: true
       - slot :inner_block, required: true
       - Renders flash_group first, then wraps inner_block in `<div class="flex flex-col min-h-screen bg-base-100">`
       - No navbar, no max-w-2xl, no py-20 - just the flash group and content wrapper

    2. In status_badge.ex, update the running badge to include animate-pulse:
       - Change `defp badge_class("running")` from `"badge badge-info"` to `"badge badge-info animate-pulse"`
       - This provides the subtle pulsing animation per user decision

    Reference: Research Pattern 1 (Dedicated Run Layout) and Pattern 4 (Pulsing Running Badge)
  </action>
  <verify>
    - grep for `def run(assigns)` in layouts.ex
    - grep for `animate-pulse` in status_badge.ex
  </verify>
  <done>
    - run/1 layout function exists in layouts.ex
    - StatusBadge running state uses animate-pulse class
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor RunLive.Show with sticky header, tabs, and elapsed ticker</name>
  <files>
    apps/athanor_web/lib/athanor_web/live/experiments/run_live/show.ex
    apps/athanor_web/lib/athanor_web/live/experiments/components/log_panel.ex
    apps/athanor_web/lib/athanor_web/live/experiments/components/results_panel.ex
  </files>
  <action>
    Major refactor of show.ex:

    1. **Mount changes:**
       - Return `{:ok, socket, layout: {AthanorWeb.Layouts, :run}}` to use the new layout
       - Add new assigns: `:active_tab` (default :logs), `:elapsed_seconds`, `:reconnecting` (false), `:reconnect_attempts` (0), `:needs_refresh` (false)
       - Start elapsed time ticker if run.status == "running" and connected?(socket):
         `Process.send_after(self(), :tick, 1_000)`
       - Calculate initial elapsed_seconds: `elapsed_since(run.started_at)` if running, else 0

    2. **New handle_info clauses:**
       - `:tick` - If run.status is "running", schedule next tick and update elapsed_seconds. If not running, do nothing (stops ticker).
       - Update existing `:run_updated` handler to freeze elapsed_seconds when run transitions to terminal state

    3. **New handle_event clauses:**
       - `"switch_tab"` - Set :active_tab to the atom from phx-value-tab (use String.to_existing_atom)
       - `"reconnecting"` - Set reconnecting: true, reconnect_attempts: n from params
       - `"reconnected"` - Set reconnecting: false, needs_refresh: true
       - `"refresh_data"` - Re-query logs/results from DB, reset streams (same as mount logic), set needs_refresh: false

    4. **New helper functions:**
       - `elapsed_since(started_at)` - DateTime.diff from started_at to now in seconds, return 0 if nil
       - `format_elapsed(run, elapsed_seconds)` - Pattern match: if completed_at exists use format_duration, if running use format_seconds, else ""
       - `format_seconds(s)` - Format as "Xs" or "Xm Xs"

    5. **Render function complete rewrite:**
       Structure (refer to Research Pattern 2 for sticky header):
       ```
       <div class="flex flex-col min-h-screen" id="run-page" phx-hook="ReconnectionTracker">

         <!-- Sticky header -->
         <header class="sticky top-0 z-10 bg-base-100 border-b border-base-300 shadow-sm">
           <div class="px-4 sm:px-6 lg:px-8 py-3">
             <!-- Breadcrumb row -->
             <div class="flex items-center gap-2 text-sm text-base-content/60 mb-2">
               Experiments > {@instance.name} > Run {short_id(@run.id)}
             </div>

             <!-- Status row -->
             <div class="flex items-center gap-4 flex-wrap">
               <StatusBadge.status_badge status={@run.status} />
               <span class="font-medium">{@instance.name}</span>
               <span class="text-sm text-base-content/60">{format_elapsed(@run, @elapsed_seconds)}</span>
               <ProgressBar (if running and progress exists)>
               <Reconnecting indicator :if={@reconnecting}>
               <div class="ml-auto flex items-center gap-2">
                 <Refresh button :if={@needs_refresh}>
                 <Cancel button :if={running}>
               </div>
             </div>

             <!-- Error display -->
             <div :if={@run.error}>...</div>
           </div>
         </header>

         <!-- Tab bar + content -->
         <div class="flex-1 flex flex-col overflow-hidden px-4 sm:px-6 lg:px-8">
           <!-- Tab bar with daisyUI tabs -->
           <div role="tablist" class="tabs tabs-border border-b border-base-300 mt-4">
             <button role="tab" class={["tab", @active_tab == :logs && "tab-active"]} phx-click="switch_tab" phx-value-tab="logs">
               Logs ({@log_count})
             </button>
             <button role="tab" class={["tab", @active_tab == :results && "tab-active"]} phx-click="switch_tab" phx-value-tab="results">
               Results ({@result_count})
             </button>
           </div>

           <!-- Tab panels - use hidden class for inactive -->
           <div class={["flex-1 overflow-y-auto py-4", @active_tab != :logs && "hidden"]}>
             <LogPanel.log_panel ... />
           </div>
           <div class={["flex-1 overflow-y-auto py-4", @active_tab != :results && "hidden"]}>
             <ResultsPanel.results_panel ... />
           </div>
         </div>
       </div>
       ```

    6. **Update LogPanel and ResultsPanel** to remove their card wrappers:
       - LogPanel: Remove outer `<div class="card bg-base-200"><div class="card-body">` wrapper and card-title, keep inner content
       - ResultsPanel: Same - remove card wrapper, keep content
       - They now render directly within the tab panel without card chrome

    Reference: Research Patterns 2, 3, 5 for sticky header, tabs, and elapsed ticker patterns
  </action>
  <verify>
    - `mix compile` succeeds
    - grep for `layout:.*:run` in show.ex confirms layout override
    - grep for `:active_tab` in show.ex confirms tab state
    - grep for `:tick` in show.ex confirms elapsed ticker
    - grep for `role="tablist"` in show.ex confirms tab markup
  </verify>
  <done>
    - RunLive.Show uses :run layout
    - Sticky header with breadcrumb, status, elapsed time, cancel button
    - Tab bar with Logs/Results showing counts
    - Elapsed time ticker updates every second while running
    - Tab switching works via phx-click events
    - LogPanel and ResultsPanel render without card wrappers
  </done>
</task>

<task type="auto">
  <name>Task 3: Add ReconnectionTracker JS hook</name>
  <files>apps/athanor_web/assets/js/app.js</files>
  <action>
    Add ReconnectionTracker hook to the Hooks object in app.js (after AutoScroll):

    ```javascript
    ReconnectionTracker: {
      mounted() {
        this.attempts = 0
        this.attemptInterval = null
      },
      disconnected() {
        this.attempts = 0
        // Count attempts every 2s as rough approximation
        // Phoenix socket uses exponential backoff internally
        this.attemptInterval = setInterval(() => {
          this.attempts += 1
          this.pushEvent("reconnecting", { attempt: this.attempts })
        }, 2000)
      },
      reconnected() {
        clearInterval(this.attemptInterval)
        this.attemptInterval = null
        this.pushEvent("reconnected", {})
      },
      destroyed() {
        clearInterval(this.attemptInterval)
      }
    }
    ```

    The hook is attached to the run page's root div (id="run-page" phx-hook="ReconnectionTracker").

    Reference: Research Pattern 6 for reconnection hook
  </action>
  <verify>
    - grep for `ReconnectionTracker:` in app.js
    - grep for `disconnected()` and `reconnected()` in app.js
    - grep for `destroyed()` in app.js confirms cleanup
  </verify>
  <done>
    - ReconnectionTracker hook exists in app.js Hooks object
    - Hook tracks disconnect, counts attempts, pushes events to server
    - Hook cleans up interval on reconnected and destroyed
  </done>
</task>

</tasks>

<verification>
Run the following checks after all tasks:

1. **Compilation check:**
   ```bash
   cd apps/athanor_web && mix compile
   ```

2. **Layout function exists:**
   ```bash
   grep -n "def run(assigns)" lib/athanor_web/components/layouts.ex
   ```

3. **Pulsing badge:**
   ```bash
   grep -n "animate-pulse" lib/athanor_web/live/experiments/components/status_badge.ex
   ```

4. **Layout override in mount:**
   ```bash
   grep -n "layout:.*:run" lib/athanor_web/live/experiments/run_live/show.ex
   ```

5. **Tab state and switching:**
   ```bash
   grep -n "active_tab" lib/athanor_web/live/experiments/run_live/show.ex | head -10
   grep -n "switch_tab" lib/athanor_web/live/experiments/run_live/show.ex
   ```

6. **Elapsed ticker:**
   ```bash
   grep -n ":tick" lib/athanor_web/live/experiments/run_live/show.ex
   grep -n "elapsed_seconds" lib/athanor_web/live/experiments/run_live/show.ex | head -5
   ```

7. **Reconnection hook:**
   ```bash
   grep -n "ReconnectionTracker" assets/js/app.js
   ```

8. **Panels without card wrappers:**
   ```bash
   grep -n "card bg-base-200" lib/athanor_web/live/experiments/components/log_panel.ex || echo "No card wrapper (good)"
   grep -n "card bg-base-200" lib/athanor_web/live/experiments/components/results_panel.ex || echo "No card wrapper (good)"
   ```
</verification>

<success_criteria>
1. RunLive.Show renders with sticky header containing status badge, experiment name, elapsed time, progress, and cancel button
2. Status badge pulses with animate-pulse during running state
3. Elapsed time updates every second while running, freezes when completed
4. Tabs show "Logs (N)" and "Results (M)" with counts
5. Logs tab is active by default
6. Tab switching works without full page refresh
7. Reconnection shows "Reconnecting (attempt N)..." indicator
8. Refresh button appears after reconnection
9. Application compiles without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/04-run-page-layout-and-status/04-01-SUMMARY.md`
</output>
