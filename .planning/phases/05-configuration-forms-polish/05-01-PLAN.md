---
phase: 05-configuration-forms-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/athanor/lib/experiment/config_schema.ex
  - apps/substrate_shift/lib/substrate_shift.ex
autonomous: true

must_haves:
  truths:
    - "Schema properties render in definition order"
    - "Fields can have description/help text"
    - "Fields can be marked as required"
    - "String fields support format hints (text, textarea, url, email)"
    - "Integer fields support min/max/step constraints"
    - "Enum fields define selectable options"
    - "Group function organizes fields into logical sections"
  artifacts:
    - path: "apps/athanor/lib/experiment/config_schema.ex"
      provides: "Extended ConfigSchema with group/4, enhanced field/4, enum type, ordered properties"
      contains: "def group"
    - path: "apps/substrate_shift/lib/substrate_shift.ex"
      provides: "Example schema using new features"
      contains: "description:"
  key_links:
    - from: "apps/athanor/lib/experiment/config_schema.ex"
      to: "apps/substrate_shift/lib/substrate_shift.ex"
      via: "import via use Athanor.Experiment"
      pattern: "field.*description:"
---

<objective>
Extend ConfigSchema with group/4, enhanced field options, enum type, and ordered properties.

Purpose: Foundation for all form rendering features - without ordered properties and extended field metadata, the form component cannot render grouped layouts, validation, or proper input types.

Output: Enhanced ConfigSchema module ready for form component consumption.
</objective>

<execution_context>
@/Users/binarymuse/.claude/get-shit-done/workflows/execute-plan.md
@/Users/binarymuse/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-configuration-forms-polish/05-CONTEXT.md
@.planning/phases/05-configuration-forms-polish/05-RESEARCH.md

@apps/athanor/lib/experiment/config_schema.ex
@apps/substrate_shift/lib/substrate_shift.ex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ConfigSchema with ordered properties and enhanced field options</name>
  <files>apps/athanor/lib/experiment/config_schema.ex</files>
  <action>
Refactor ConfigSchema to use ordered properties (list of tuples instead of map) and add all new field options:

1. Change `properties: %{}` to `properties: []` in struct and `new/0`

2. Update `field/4` to append `{name, field_def}` tuple to list instead of Map.put:
   - Add opts: `:label`, `:description`, `:required` (boolean), `:format` (for strings: :text, :textarea, :url, :email), `:min`, `:max`, `:step` (for integers), `:options` (for enum type)
   - Handle `:enum` as a type that requires `:options` list

3. Update `list/4` similarly to append tuple, add `:label`, `:description` opts

4. Add `group/4` function:
   ```elixir
   def group(%__MODULE__{} = schema, name, sub_schema, opts \\ []) do
     label = Keyword.get(opts, :label, nil)
     description = Keyword.get(opts, :description, nil)

     %{
       schema
       | properties: schema.properties ++ [{name, %{
           type: :group,
           label: label,
           description: description,
           sub_schema: sub_schema
         }}]
     }
   end
   ```

5. Update `__using__` macro to import `group: 3, group: 4`

6. Add a `get_property/2` helper for lookup by name (searches list):
   ```elixir
   def get_property(%__MODULE__{properties: props}, name) do
     Enum.find_value(props, fn {n, def} -> if n == name, do: def end)
   end
   ```
  </action>
  <verify>
Run `mix compile` in apps/athanor - no warnings or errors about undefined functions.
Existing `apps/substrate_shift/lib/substrate_shift.ex` still compiles (backward compatible).
  </verify>
  <done>
ConfigSchema supports ordered properties (list), field options (description, required, format, min/max/step, options), enum type, group/4 function, and get_property/2 lookup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SubstrateShift schema to demonstrate new features</name>
  <files>apps/substrate_shift/lib/substrate_shift.ex</files>
  <action>
Enhance the SubstrateShift config schema to showcase the new ConfigSchema features:

1. Add descriptions and labels to existing fields:
   ```elixir
   |> field(:runs_per_pair, :integer,
        default: 10,
        label: "Runs Per Pair",
        description: "Number of test runs for each model pair",
        min: 1,
        max: 100,
        required: true)
   ```

2. Add descriptions to model_pair_schema fields:
   ```elixir
   model_pair_schema =
     Experiment.ConfigSchema.new()
     |> field(:model_a, :string,
          default: "gpt-4o",
          label: "Model A",
          description: "First model in the comparison pair",
          required: true)
     |> field(:model_b, :string,
          default: "gpt-4o-mini",
          label: "Model B",
          description: "Second model in the comparison pair",
          required: true)
   ```

3. Add a label/description to the list field:
   ```elixir
   |> list(:model_pairs, model_pair_schema,
        label: "Model Pairs",
        description: "Pairs of models to compare in the experiment")
   ```

This validates the schema API is working and provides a real example for form rendering.
  </action>
  <verify>
Run `mix compile` in umbrella root - no errors.
Run `iex -S mix` and call `SubstrateShift.config().properties` to verify it returns a list of tuples with enhanced field definitions.
  </verify>
  <done>
SubstrateShift schema demonstrates all new ConfigSchema features: labels, descriptions, constraints, required flags on a real experiment.
  </done>
</task>

</tasks>

<verification>
1. `mix compile` succeeds with no warnings
2. `SubstrateShift.config().properties` returns ordered list (not map)
3. Each property tuple contains enhanced field metadata (label, description, required, etc.)
4. `Athanor.Experiment.ConfigSchema.get_property/2` can look up fields by name
</verification>

<success_criteria>
- ConfigSchema properties are ordered lists preserving definition sequence
- field/4 accepts all new options: label, description, required, format, min, max, step, options
- list/4 accepts label, description options
- group/4 creates grouping containers with sub_schema
- :enum type works with options list
- Existing SubstrateShift experiment compiles and demonstrates features
- get_property/2 enables name-based lookup from list structure
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-forms-polish/05-01-SUMMARY.md`
</output>
